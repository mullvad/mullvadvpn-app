name: iOS settings migration tests
concurrency:
  group: ios-end-to-end-tests
  cancel-in-progress: false

permissions:
  contents: read
  issues: write
  pull-requests: write

on:
  workflow_dispatch:
  schedule:
    # At midnight every day.
    # Notifications for scheduled workflows are sent to the user who last modified the cron
    # syntax in the workflow file. If you update this you must have notifications for
    # Github Actions enabled, so these don't go unnoticed.
    # https://docs.github.com/en/actions/monitoring-and-troubleshooting-workflows/notifications-for-workflow-runs
    - cron: '0 0 * * *'

# Define global environment variables here to make them easy to update
env:
  TEST_DEVICE_UDID: 00008130-0019181022F3803A
  OLD_APP_COMMIT_HASH: "1c2efc6d3d40c1d168a90ac52e872274e74bb6f3"

jobs:
  set_commit_hash:
    name: Set Commit Hash Environment Variable
    runs-on:
      - self-hosted
      - macOS
      - ios-test
    outputs:
      old_app_commit_hash: ${{ steps.set-hash.outputs.old_app_commit_hash }}
    steps:
      - name: Set OLD_APP_COMMIT_HASH
        id: set-hash
        run: echo "::set-output name=old_app_commit_hash::${{ env.OLD_APP_COMMIT_HASH }}"

  uninstall_app:
    name: Uninstall Old App
    runs-on:
      - self-hosted
      - macOS
      - ios-test
    needs: set_commit_hash
    steps:
      - name: Uninstall Old App from Device
        timeout-minutes: 5
        run: ios-deploy --id ${{ env.TEST_DEVICE_UDID }} --uninstall_only --bundle_id net.mullvad.MullvadVPN

  change_dns_settings:
    name: Change DNS Settings on Old App Version
    uses: mullvad/mullvadvpn-app/.github/workflows/ios-end-to-end-tests.yml@main
    needs:
      - set_commit_hash
      - uninstall_app
    with:
      arg_tests_json_key: "mullvadVPNUITestsChangeDNSSettings"
      commit_hash: ${{ needs.set_commit_hash.outputs.old_app_commit_hash }}
    secrets: inherit

  verify_dns_settings:
    name: Verify DNS Settings on Current App Version
    needs:
      - change_dns_settings
    uses: mullvad/mullvadvpn-app/.github/workflows/ios-end-to-end-tests.yml@main
    with:
      arg_tests_json_key: "mullvadVPNUITestsVerifyDNSSettingsChanged"
    secrets: inherit

  change_other_settings:
    name: Change All Other Settings on Old App Version
    needs:
      - set_commit_hash
      - verify_dns_settings
    uses: mullvad/mullvadvpn-app/.github/workflows/ios-end-to-end-tests.yml@main
    with:
      arg_tests_json_key: "mullvadVPNUITestsChangeSettings"
      commit_hash: ${{ needs.set_commit_hash.outputs.old_app_commit_hash }}
    secrets: inherit

  verify_other_settings:
    name: Verify All Other Settings on Current App Version
    needs:
      - change_other_settings
    uses: mullvad/mullvadvpn-app/.github/workflows/ios-end-to-end-tests.yml@main
    with:
      arg_tests_json_key: "mullvadVPNUITestsVerifySettingsChanged"
    secrets: inherit
