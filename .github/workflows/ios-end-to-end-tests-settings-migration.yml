---
name: iOS settings migration tests
concurrency:
  group: ios-end-to-end-tests
  cancel-in-progress: false
permissions:
  contents: read
on:
  workflow_dispatch:
  schedule:
    # At midnight every day.
    # Notifications for scheduled workflows are sent to the user who last modified the cron
    # syntax in the workflow file. If you update this you must have notifications for
    # Github Actions enabled, so these don't go unnoticed.
    # https://docs.github.com/en/actions/monitoring-and-troubleshooting-workflows/notifications-for-workflow-runs
    - cron: '0 0 * * *'
env:
  TEST_DEVICE_UDID: 00008130-0019181022F3803A
jobs:
  test:
    name: Settings migration end to end tests
    runs-on: [self-hosted, macOS, ios-test]
    env:
      OLD_APP_COMMIT_HASH: 895b7d98825e678f5d7023d5ea3c9b7beee89280
    steps:
      - name: Configure Rust
        uses: actions-rs/toolchain@v1.0.6
        with:
          toolchain: stable
          override: true
          target: aarch64-apple-ios
  change_dns_settings:
    name: Change DNS Settings on Old App Version
    uses: ./.github/workflows/ios-end-to-end-tests.yml
    needs:
      - set_commit_hash
    with:
      arg_tests_json_key: "mullvadVPNUITestsChangeDNSSettings"
      commit_hash: ${{ needs.set_commit_hash.outputs.old_app_commit_hash }}
      should_uninstall_app: true
    secrets: inherit

  verify_dns_settings:
    name: Verify DNS Settings on Current App Version
    needs:
      - change_dns_settings
    uses: ./.github/workflows/ios-end-to-end-tests.yml
    with:
      arg_tests_json_key: "mullvadVPNUITestsVerifyDNSSettingsChanged"
      should_uninstall_app: false
    secrets: inherit

  change_other_settings:
    name: Change All Other Settings on Old App Version
    needs:
      - set_commit_hash
      - verify_dns_settings
    uses: ./.github/workflows/ios-end-to-end-tests.yml
    with:
      arg_tests_json_key: "mullvadVPNUITestsChangeSettings"
      commit_hash: ${{ needs.set_commit_hash.outputs.old_app_commit_hash }}
      should_uninstall_app: true
    secrets: inherit

  verify_other_settings:
    name: Verify All Other Settings on Current App Version
    needs:
      - change_other_settings
    uses: ./.github/workflows/ios-end-to-end-tests.yml
    with:
      arg_tests_json_key: "mullvadVPNUITestsVerifySettingsChanged"
      should_uninstall_app: false
    secrets: inherit
