---
name: iOS settings migration tests
concurrency:
  group: ios-end-to-end-tests
  cancel-in-progress: false

permissions:
  contents: read
  issues: write
  pull-requests: write

on:
  workflow_dispatch: {}
  schedule:
    - cron: '0 0 * * *'  # At midnight every day.

env:
  TEST_DEVICE_UDID: 00008130-0019181022F3803A
  OLD_APP_COMMIT_HASH: f82b90126441e9f8afa8c820faa0e5b2c99ecc3e

jobs:
  checkout_version:
    name: Checkout Current Repository Version
    runs-on:
      - self-hosted
      - macOS
      - ios-test
    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4

  configure_rust:
    name: Configure Rust
    runs-on:
      - self-hosted
      - macOS
      - ios-test
    needs: checkout_version
    steps:
      - name: Configure Rust
        uses: actions-rs/toolchain@v1.0.6
        with:
          toolchain: stable
          override: true
          target: aarch64-apple-ios

  uninstall_app:
    name: Uninstall App
    runs-on:
      - self-hosted
      - macOS
      - ios-test
    needs: checkout_version
    steps:
      - name: Uninstall old app
        timeout-minutes: 5
        run: ios-deploy --id ${{ env.TEST_DEVICE_UDID }} --uninstall_only --bundle_id net.mullvad.MullvadVPN

  change_dns_settings:
    name: Change DNS Settings on Old App Version
    needs:
      - checkout_version
      - configure_rust
      - uninstall_app
    uses: ./.github/workflows/ios-end-to-end-tests.yml
    with:
      arg_tests_json_key: "MullvadVPNUITestsChangeDNSSettings"
      commit_hash: ${{ env.OLD_APP_COMMIT_HASH }}
    secrets: inherit

  verify_dns_settings:
    name: Verify DNS Settings Still Changed on Current App Version
    needs: change_dns_settings
    uses: ./.github/workflows/ios-end-to-end-tests.yml
    with:
      arg_tests_json_key: "MullvadVPNUITestsVerifyDNSSettingsChanged"
    secrets: inherit

  change_other_settings:
    name: Change All Other Settings on Old App Version
    needs: verify_dns_settings
    uses: ./.github/workflows/ios-end-to-end-tests.yml
    with:
      arg_tests_json_key: "MullvadVPNUITestsChangeSettings"
      commit_hash: ${{ env.OLD_APP_COMMIT_HASH }}
    secrets: inherit

  verify_other_settings:
    name: Verify All Other Settings Still Changed on Current App Version
    needs: change_other_settings
    uses: ./.github/workflows/ios-end-to-end-tests.yml
    with:
      arg_tests_json_key: "MullvadVPNUITestsVerifySettingsChanged"
    secrets: inherit
