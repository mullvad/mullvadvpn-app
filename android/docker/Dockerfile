# To build the image:
# podman build . -t mullvadvpn-app-build-android
#
# To build using the image:
# podman run --rm \
#     -v /path/to/container_cache/target:/root/.cargo/target:Z \
#     -v /path/to/container_cache/registry:/root/.cargo/registry:Z \
#     -v /path/to/container_cache/gradle:/root/.gradle:Z \
#     -v .:/build:Z \
#     mullvadvpn-app-build-android ./build-apk.sh --dev-build --no-docker
#
# See the base image Dockerfile in the repository root for more information.

# TODO: Change image once a proper one has been built and published
FROM ghcr.io/mullvad/mullvadvpn-app-build@sha256:TODO

# === Define toolchain versions and paths ===

ENV SDK_VERSION=platforms;android-33 \
    BUILD_TOOLS_VERSION=build-tools;30.0.2

# SDK tools
ENV SDK_TOOLS_VERSION=4333796 \
    SDK_TOOLS_SHA256_CHECKSUM=92ffee5a1d98d856634e8b71132e8a95d96c83a63fde1099be3d86df3106def9

# NDK and checksum from: https://github.com/android/ndk/wiki/Unsupported-Downloads
ENV NDK_VERSION=r20b \
    NDK_SHA1_CHECKSUM=d903fdf077039ad9331fb6c3bee78aa46d45527b

ENV ANDROID_HOME=/opt/android
ENV ANDROID_NDK_HOME=${ANDROID_HOME}/android-ndk-${NDK_VERSION}
ENV NDK_TOOLCHAIN_DIR=${ANDROID_NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64/bin
ENV GRADLE_USER_HOME=/root/.gradle

ENV AR_x86_64_linux_android=${NDK_TOOLCHAIN_DIR}/x86_64-linux-android-ar \
    AR_i686_linux_android=${NDK_TOOLCHAIN_DIR}/i686-linux-android-ar \
    AR_aarch64_linux_android=${NDK_TOOLCHAIN_DIR}/aarch64-linux-android-ar \
    AR_armv7_linux_androideabi=${NDK_TOOLCHAIN_DIR}/arm-linux-androideabi-ar \
    CC_x86_64_linux_android=${NDK_TOOLCHAIN_DIR}/x86_64-linux-android21-clang \
    CC_i686_linux_android=${NDK_TOOLCHAIN_DIR}/i686-linux-android21-clang \
    CC_aarch64_linux_android=${NDK_TOOLCHAIN_DIR}/aarch64-linux-android21-clang \
    CC_armv7_linux_androideabi=${NDK_TOOLCHAIN_DIR}/armv7a-linux-androideabi21-clang

# === Install/set up the image ===

RUN apt-get update -y && apt-get install -y \
    file \
    gpg \
    make \
    python \
    software-properties-common \
    unzip \
    && rm -rf /var/lib/apt/lists/*

# Install JDK
COPY adopt-openjdk-apt-key.pgp /tmp/adopt-openjdk-apt-key.pgp
RUN apt-key add < /tmp/adopt-openjdk-apt-key.pgp && \
    add-apt-repository -y https://adoptopenjdk.jfrog.io/adoptopenjdk/deb/ && \
    apt-get update && \
    apt-get install -y adoptopenjdk-8-hotspot && \
    rm /tmp/adopt-openjdk-apt-key.pgp && rm -rf /var/lib/apt/lists/*

# Install base Android SDK tools
RUN curl -sfLo /tmp/sdk-tools.zip https://dl.google.com/android/repository/sdk-tools-linux-${SDK_TOOLS_VERSION}.zip && \
    echo "$SDK_TOOLS_SHA256_CHECKSUM /tmp/sdk-tools.zip" | sha256sum -c && \
    mkdir -p $ANDROID_HOME && \
    unzip -q /tmp/sdk-tools.zip -d $ANDROID_HOME && \
    rm /tmp/sdk-tools.zip

# Install Android SDK
RUN yes | $ANDROID_HOME/tools/bin/sdkmanager $SDK_VERSION $BUILD_TOOLS_VERSION "platform-tools"

# Install Android NDK
RUN curl -sfLo /tmp/ndk.zip https://dl.google.com/android/repository/android-ndk-${NDK_VERSION}-linux-x86_64.zip && \
    echo "$NDK_SHA1_CHECKSUM /tmp/ndk.zip" | sha1sum -c && \
    unzip -q /tmp/ndk.zip -d $ANDROID_HOME && \
    rm /tmp/ndk.zip

# Apply go patch required for Android
# NOTE: The go path must match the one used in the base image.
COPY goruntime-boottime-over-monotonic.diff /tmp/goruntime-boottime-over-monotonic.diff
RUN patch -p1 -f -N -r- -d /usr/local/go < /tmp/goruntime-boottime-over-monotonic.diff && \
    rm /tmp/goruntime-boottime-over-monotonic.diff

# Add rust targets
# NOTE: The config.toml overrides the one created in the base image.
COPY cargo-config.toml /root/.cargo/config.toml
RUN rustup target add x86_64-linux-android i686-linux-android aarch64-linux-android armv7-linux-androideabi

WORKDIR /build
